# raft

## HashiCorp公司简介

在 HashiCorp，我们正在建立一个定义时代的基础设施软件公司，由不断壮大的才华横溢、敬业的专业人士组成的团队提供支持，共同帮助组织无缝过渡到云并在云中运营。

## 协议描述

raft 基于“Raft：寻找可理解的共识算法” [论文地址](https://raft.github.io/raft.pdf)

下面描述了 Raft 协议的高级概述，但有关详细信息，请阅读完整的 [Raft 论文](https://raft.github.io/raft.pdf)和 raft 源代码。 任何关于 raft 协议的问题都应该发送到 raft-dev 邮件列表。



Raft 节点始终处于以下三种状态之一：follower、candidate 或 leader。所有节点最初都是作为跟随者开始的。在这种状态下，节点可以接受来自领导者的日志条目并投票。如果一段时间内没有收到任何条目，节点会自我提升到候选状态。在候选状态中，节点向其对等节点请求投票。如果候选人获得法定人数的选票，则将其提升为领导者。领导者必须接受新的日志条目并复制到所有其他追随者。此外，如果不接受过时的读取，则所有查询也必须在领导者上执行。

一旦集群有了领导者，它就能够接受新的日志条目。客户端可以请求领导者附加一个新的日志条目，这是一个不透明的二进制 blob 到 Raft。然后领导者将条目写入持久存储并尝试复制到法定数量的追随者。一旦日志条目被认为已提交，它就可以应用于有限状态机。有限状态机是特定于应用程序的，并且是使用接口实现的。

一个明显的问题与复制日志的无限性质有关。 Raft 提供了一种机制，通过它可以对当前状态进行快照，并压缩日志。由于 FSM 抽象，恢复 FSM 的状态必须导致与旧日志重放相同的状态。这允许 Raft 在某个时间点捕获 FSM 状态，然后删除所有用于达到该状态的日志。这是在没有用户干预的情况下自动执行的，并且可以防止无限制的磁盘使用以及最大限度地减少重播日志所花费的时间。

最后，当新服务器加入或现有服务器离开时更新对等点集的问题。只要有足够数量的节点可用，这不是问题，因为 Raft 提供了动态更新对等点集的机制。如果节点的法定人数不可用，那么这将成为一个非常具有挑战性的问题。例如，假设只有 2 个对等点，A 和 B。仲裁大小也是 2，这意味着两个节点必须同意提交日志条目。如果 A 或 B 失败，现在就不可能达到法定人数。这意味着集群无法添加或删除节点，或提交任何额外的日志条目。这导致不可用。此时，需要手动干预来删除 A 或 B，并以引导模式重新启动剩余的节点。

一个 3 个节点的 Raft 集群可以容忍一个节点故障，而一个 5 个节点的集群可以容忍 2 个节点故障。推荐的配置是运行 3 个或 5 个 raft 服务器。这在不大大牺牲性能的情况下最大限度地提高了可用性。

在性能方面，Raft 可与 Paxos 媲美。假设稳定的领导，提交日志条目需要单次往返集群的一半。因此，性能受磁盘 I/O 和网络延迟的限制。